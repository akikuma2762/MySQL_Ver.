using dek_erpvis_v2.cls;
using Support;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace dek_erpvis_v2.pages.dp_PD
{
    public partial class materialrequirementplanning_details : System.Web.UI.Page
    {
        public string color = "";
        public string title_text = "";
        public string pie_data_points = "";
        public string col_data_points = "";
        public string for_what = "";
        public string th = "";
        public string tr = "";
        public string date_str = "";
        public string date_end = "";
        string item_code = "";
        string acc = "";

        DataTable public_dt = null;
        myclass myclass = new myclass();
        clsDB_Server clsDB_sw = new clsDB_Server("");
        protected void Page_Load(object sender, EventArgs e)
        {
      DateTime start = DateTime.Now;
            HttpCookie userInfo = Request.Cookies["userInfo"];
            if (userInfo != null)
            {
                acc = DataTableUtils.toString(userInfo["user_ACC"]);
                color = HtmlUtil.change_color(acc);
                if (acc != "")
                {
                    if (!IsPostBack)
                    {
                        GotoCenn();
                    }
                }
                else
                {
                    Response.Redirect("materialrequirementplanning.aspx", false);
                }
            }
            else
            {
                Response.Redirect("materialrequirementplanning.aspx", false);
            }
      
            DateTime end = DateTime.Now;
            string url = System.IO.Path.GetFileName(Request.PhysicalPath).Split('.')[0];
            HtmlUtil.Time_Look(acc, url, start, end);
        }
        private void GotoCenn()
        {
            clsDB_sw.dbOpen(myclass.GetConnByDetaSowon);
            if (clsDB_sw.IsConnected == true)
            {
                load_page_data();
            }
            else
            {
                Response.Write("<script language='javascript'>alert('伺服器回應 : 無法載入資料，" + clsDB_sw.ErrorMessage + " 請聯絡德科人員或檢查您的網路連線。');</script>");
                title_text = HtmlUtil.NoData(out th, out tr);
            }
        }
        private void load_page_data()
        {
            Response.BufferOutput = false;
            if (Request.QueryString["key"] != null)
            {
                string[] str = HtmlUtil.Return_str(Request.QueryString["key"]);
                item_code = str[1];
                date_str = str[3];
                date_end = str[5];
                title_text = item_code;

                Response.BufferOutput = false;
                set_col_value();
                set_table_title();
            }
            else
            {
                Response.Redirect("materialrequirementplanning.aspx", false);
            }
        }
        private void set_col_value()
        {
            string strCmd = 德大機械.資材部_物料領用統計詳細.用途說明_明細表(item_code, date_str, date_end);
            DataTable dt = clsDB_sw.GetDataTable(strCmd);
            int i = 0;
            foreach (DataRow row_用途 in dt.Rows)
            {
                i++;
                int TotalOfPart = 0;
                string dataPoints = "";
                
                string 用途說明 = DataTableUtils.toString(row_用途["用途說明"]);
                strCmd = 德大機械.資材部_物料領用統計詳細.領料月份(item_code, date_str, date_end);
                DataTable dr = clsDB_sw.GetDataTable(strCmd);
                foreach (DataRow row_月份 in dr.Rows)
                {
                    string row_用途說明 = DataTableUtils.toString(row_用途["用途說明"]);
                    string row_領料月份 = DataTableUtils.toString(row_月份["領料月份"]);
                    strCmd = 德大機械.資材部_物料領用統計詳細.每月物料領用數量(item_code, date_str, date_end, row_用途說明, row_領料月份);
                    DataTable dt_row = clsDB_sw.GetDataTable(strCmd);
                    if (dt_row.Rows.Count > 0)
                    {
                        int val = DataTableUtils.toInt(DataTableUtils.toString(dt_row.Rows[0]["領料數"]).Split('.')[0]);
                        TotalOfPart += val;
                        dataPoints += "{ y: " + val + ", label: '" + DataTableUtils.toString(row_月份["領料月份"]) + "' },";
                    }
                    else if(dt_row.Rows.Count <= 0)
                    {
                        dataPoints += "{ y: " + 0 + ", label: '"+ DataTableUtils.toString(row_月份["領料月份"]) + "' },";
                    }
                }
                col_data_points += "{ type: 'stackedColumn', showInLegend: true, name:'"+ 用途說明 + "', dataPoints: ["+ dataPoints + "] },";
                if (i == dt.Rows.Count)
                {
                    pie_data_points += "{y:" + TotalOfPart + ",name:'" + 用途說明 + " " + TotalOfPart + "', label:'" + 用途說明 + "',exploded: true},";//color:'#f77b71',
                }
                else
                {
                    pie_data_points += "{y:" + TotalOfPart + ",name:'" + 用途說明 + " " + TotalOfPart + "', label:'" + 用途說明 + "'},";//color:'#f77b71',exploded: true
                }
                
            }
        }
        private void set_table_title()
        {
            string sqlcmd = 德大機械.資材部_物料領用統計詳細.品號領料紀錄(item_code, date_str, date_end);
            public_dt = clsDB_sw.GetDataTable(sqlcmd);

            string titlename = "";
            th = HtmlUtil.Set_Table_Title(public_dt, out titlename);
            tr = HtmlUtil.Set_Table_Content(public_dt, titlename);

        }
       
    }
}