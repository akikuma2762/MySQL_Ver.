using dek_erpvis_v2.cls;
using Support;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace dek_erpvis_v2.pages.dp_APS
{
    public partial class APSList : System.Web.UI.Page
    {
        public string color = "";
        string acc = "";
        public string th = "";
        public string tr = "";
        myclass myclass = new myclass();
        //網頁載入事件
        protected void Page_Load(object sender, EventArgs e)
        {
            HttpCookie userInfo = Request.Cookies["userInfo"];
            if (userInfo != null)
            {
                acc = DataTableUtils.toString(userInfo["user_ACC"]);
                color = HtmlUtil.change_color(acc);
                string URL_NAME = "APSList";
                if (myclass.user_view_check(URL_NAME, acc) == true)
                {
                    if (!IsPostBack)
                    {
                        getdata();
                    }
                }
                else { Response.Write("<script>alert('您無法瀏覽此頁面 請向該單位主管申請權限!');location.href='../index.aspx';</script>"); }


            }
            else Response.Redirect(myclass.logout_url);
        }
        //印出表格欄位以及內容
        private void getdata()
        {
            GlobalVar.UseDB_setConnString(myclass.GetConnByDekAPS);
            //最後面的是因為其他網站都是用字串分割的方式，所以會多出一個""
            string[] str = {"狀態", "排程訂單編號", "產品名稱",
                            "工藝名稱", "機台名稱", "預定起始時間",
                            "預定結束時間", "累積數量", "需求總數量", "備註" ,""};
            for (int i = 0; i < str.Length - 1; i++)
            {
                th += "<th>" + str[i] + "</th>";
            }
            /*之後要讓使用者自己調整欄位就改這裡*/


            /*之後要讓使用者自己調整欄位就改這裡*/
            string sql_cmd = "SELECT Status as 狀態," +
                                    "Project as 排程訂單編號," +
                                    "Job as 產品名稱," +
                                    "TaskName as 工藝名稱," +
                                    "Resource as 機台名稱," +
                                    "StartTime as 預定起始時間," +
                                    "EndTime as 預定結束時間," +
                                    "CurrentPiece as 累積數量," +
                                    "TagetPiece as 需求總數量," +
                                    "Note as 備註" +
                                    " FROM dek_aps.workhour as a ";
            DataTable dt = DataTableUtils.GetDataTable(sql_cmd);
            tr = HtmlUtil.Set_Table_Content(dt, str, aps_callback);
        }
        //callback執行的地方
        private string aps_callback(DataRow row, string field_name)
        {
            string value = "";

            if (field_name == "狀態")
            {
                if (DataTableUtils.toString(row["狀態"]) == "")
                    value = "<img class='img-rounded' src='../../assets/images/待機.PNG' alt='...' style='width:35px;height:35px;align-items:left;'>";

                else
                    value = "<img class='img-rounded' src='../../assets/images/" + DataTableUtils.toString(row["狀態"]) + ".PNG' alt='...' style='width:35px;height:35px;align-items:left;'>";
            }
            if (field_name == "累積數量")
            {
                string sql_cmd = "SELECT Piece from dek_aps.workhour_detail where Project = '" + DataTableUtils.toString(row["排程訂單編號"]) + "' and TaskName = '" + DataTableUtils.toString(row["工藝名稱"]) + "'";
                DataTable dt = DataTableUtils.GetDataTable(sql_cmd);
                int total = 0;
                foreach (DataRow rew in dt.Rows)
                    total += DataTableUtils.toInt(DataTableUtils.toString(rew["piece"]));
                value = total.ToString();
            }
            if (field_name == "預定起始時間" || field_name == "預定結束時間")
            {
                DateTime dt = DateTime.ParseExact(DataTableUtils.toString(row[field_name]), "yyyyMMddHHmmss", System.Globalization.CultureInfo.CurrentCulture);
                value = dt.ToString("yyyy-MM-dd tt hh:mm:ss", System.Globalization.CultureInfo.CurrentCulture);
            }

            return "<td>" + value + "</td>\n";
        }
    }
}