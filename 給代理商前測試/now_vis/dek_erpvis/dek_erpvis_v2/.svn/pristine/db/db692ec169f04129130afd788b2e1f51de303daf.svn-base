using dek_erpvis_v2.cls;
using Support;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace dek_erpvis_v2.pages.dp_PD
{
    public partial class supplierscore_details : System.Web.UI.Page
    {
        public string color = "";
        public string sup_sname = "";
        public string date_str = "";
        public string date_end = "";
        public string th = "";
        public string tr = "";
        public string acc = "";
        myclass myclass = new cls.myclass();
        clsDB_Server clsDB_sw = new clsDB_Server("");
        DataTable public_dt = null;
        protected void Page_Load(object sender, EventArgs e)
        {
            DateTime start = DateTime.Now;
            HttpCookie userInfo = Request.Cookies["userInfo"];
            if (userInfo != null)
            {
                acc = DataTableUtils.toString(userInfo["user_ACC"]);
                color = HtmlUtil.change_color(acc);
                if (acc != "")
                {
                    if (!IsPostBack)
                    {
                        GotoCenn();
                    }
                }
                else
                {
                    Response.Redirect("supplierscore.aspx.aspx", false);
                }
            }
            else
            {
                Response.Redirect("supplierscore.aspx", false);
            }

            DateTime end = DateTime.Now;
            string url = System.IO.Path.GetFileName(Request.PhysicalPath).Split('.')[0];
            HtmlUtil.Time_Look(acc, url, start, end);
        }
        //event
        private void GotoCenn()
        {
            clsDB_sw.dbOpen(myclass.GetConnByDetaSowon);
            if (clsDB_sw.IsConnected == true)
            {
                load_page_data();
            }
            else
            {
                Response.Write("<script language='javascript'>alert('伺服器回應 : 無法載入資料，" + clsDB_sw.ErrorMessage + " 請聯絡德科人員或檢查您的網路連線。');</script>");
                HtmlUtil.NoData(out th, out tr);
            }
        }
        private void load_page_data()
        {
            Response.BufferOutput = false;
            if (Request.QueryString["key"] != null)
            {
                string[] str = HtmlUtil.Return_str(Request.QueryString["key"]);
                if (str.Length > 1)
                {
                    sup_sname = str[1];
                    date_str = str[3];
                    date_end = str[5];
                    Set_Html_Table();
                }                
            }
            else
            {
                Response.Redirect("supplierscore.aspx", false);
            }
        }
        private void Set_Html_Table()
        {
            string col_name = "";
            string sqlcmd = 德大機械.資材部_供應商達交率明細表.供應商交貨明細表(sup_sname, date_str, date_end);
            public_dt = clsDB_sw.GetDataTable(sqlcmd);

            string titlename = "";
            th = HtmlUtil.Set_Table_Title(public_dt, out titlename);
            tr = HtmlUtil.Set_Table_Content(public_dt, titlename,supplierscore_details_callback);

        }
        private string supplierscore_details_callback(DataRow row, string field_name)
        {
            string value = "";
            if (field_name == "採購數量")
            {
                value = "<td>"+DataTableUtils.toString(row["採購數量"]).Split('.')[0]+"</td>\n";
            }
            if (field_name == "期限內已交數量")
            {
                value = "<td>" + DataTableUtils.toString(row["期限內已交數量"]).Split('.')[0] + "</td>\n"; ;
            }
            if (field_name == "採購單日期")
            {
                value = "<td>" + myclass.string_format(DataTableUtils.toString(row["採購單日期"])) + "</td>\n"; ;
            }
            if (field_name == "預交日期")
            {
                value = "<td>" + myclass.string_format(DataTableUtils.toString(row["預交日期"])) + "</td>\n"; ;
            }
            if (field_name == "期限內最後進貨日期")
            {
                value = "<td>" + myclass.string_format(DataTableUtils.toString(row["期限內最後進貨日期"])) + "</td>\n"; ;
            }
            return value;
        }
      
    }
}
